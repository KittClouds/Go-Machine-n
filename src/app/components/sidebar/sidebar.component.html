<!-- Sidebar Shell -->
<aside
    class="h-full border-r border-sidebar-border bg-sidebar text-sidebar-foreground flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
    [class.w-64]="sidebarService.isOpen()" [class.w-14]="sidebarService.isCollapsed()"
    [class.w-0]="sidebarService.isClosed()">

    <!-- Sidebar Header with Action Buttons -->
    <div class="h-10 flex items-center justify-between px-3 border-b border-teal-900/40 bg-gradient-to-r from-[#18181b] via-[#0f2a2e] to-[#134e4a] text-slate-200 shrink-0 shadow-sm"
        [class.px-2]="sidebarService.isCollapsed()" [class.justify-center]="sidebarService.isCollapsed()">

        <!-- Title (only when open) -->
        <span *ngIf="sidebarService.isOpen()" class="text-sm font-semibold text-slate-200">Navigator</span>

        <!-- Quick Action Buttons -->
        <div class="flex items-center gap-1" [class.flex-col]="sidebarService.isCollapsed()">
            <!-- New Note Button -->
            <button class="p-1.5 rounded-md hover:bg-white/10 text-slate-400 hover:text-white transition-colors"
                [title]="sidebarService.isCollapsed() ? 'New Note' : ''" (click)="createNote()">
                <lucide-icon [img]="Plus" size="16"></lucide-icon>
            </button>

            <!-- Folder Dropdown Trigger (only when open) -->
            <div class="relative" *ngIf="sidebarService.isOpen()">
                <button class="p-1.5 rounded-md hover:bg-white/10 text-slate-400 hover:text-white transition-colors"
                    title="New Folder" (click)="toggleFolderDropdown()">
                    <lucide-icon [img]="FolderPlus" size="16"></lucide-icon>
                </button>

                <!-- Folder Dropdown Menu -->
                <div *ngIf="folderDropdownOpen()"
                    class="absolute top-full left-0 mt-1 z-[1000] min-w-56 bg-popover border border-border rounded-lg shadow-xl py-1 text-sm">

                    <!-- Entity Folders Header -->
                    <div class="px-3 py-1.5 text-xs font-medium text-muted-foreground uppercase tracking-wide">
                        Entity Folders
                    </div>

                    <!-- Entity Folder Options -->
                    <button *ngFor="let option of entityFolderOptions" class="folder-menu-item"
                        (click)="createEntityFolder(option)">
                        <lucide-icon [img]="option.icon" size="14" [style.color]="option.color"></lucide-icon>
                        <span class="flex-1">{{ option.label }}</span>
                        <span class="text-[10px] font-medium px-1.5 py-0.5 rounded"
                            [style.background-color]="option.color" [style.color]="'white'">
                            {{ option.entityKind }}
                        </span>
                    </button>

                    <!-- Divider -->
                    <div class="h-px bg-border my-1"></div>

                    <!-- Regular Folder -->
                    <button class="folder-menu-item" (click)="createRegularFolder()">
                        <lucide-icon [img]="Folder" size="14" class="text-muted-foreground"></lucide-icon>
                        <span class="flex-1">Regular Folder</span>
                    </button>
                </div>
            </div>

            <!-- Create Narrative Vault Button -->
            <button
                class="p-1.5 rounded-md hover:bg-purple-500/20 text-purple-400 hover:text-purple-300 transition-colors"
                [title]="sidebarService.isCollapsed() ? 'New Narrative' : 'Create Narrative Vault'"
                (click)="createNarrative()">
                <lucide-icon [img]="BookOpen" size="16"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- Backdrop to close dropdown -->
    <div *ngIf="folderDropdownOpen()" class="fixed inset-0 z-40" (click)="closeFolderDropdown()">
    </div>

    <!-- Sidebar Content -->
    <div class="flex-1 overflow-hidden">
        <!-- Full tree when open -->
        <app-file-tree *ngIf="sidebarService.isOpen()" [tree]="treeData()"></app-file-tree>

        <!-- Collapsed icons view -->
        <div *ngIf="sidebarService.isCollapsed()" class="flex flex-col items-center py-2 gap-1 overflow-y-auto h-full">
            <!-- Icon only list -->
            <button *ngFor="let node of collapsedNodes()"
                class="w-10 h-8 flex items-center justify-center rounded-md hover:bg-accent transition-colors"
                [title]="node.name" (click)="onCollapsedNodeClick(node)">
                <lucide-icon [img]="getNodeIcon(node)" size="16" [style.color]="node.color || 'currentColor'"
                    class="text-muted-foreground">
                </lucide-icon>
            </button>
        </div>
    </div>

    <!-- Sidebar Footer -->
    <div class="h-8 flex items-center px-3 border-t border-sidebar-border shrink-0"
        [class.justify-center]="sidebarService.isCollapsed()" [class.px-1]="sidebarService.isCollapsed()">

        <!-- Item count (only when open) -->
        <span *ngIf="sidebarService.isOpen()" class="text-xs text-muted-foreground flex-1">
            {{ treeData().length }} items
        </span>

        <!-- Collapse/Expand Toggle -->
        <button class="p-1 rounded hover:bg-accent text-muted-foreground hover:text-foreground transition-colors"
            [title]="sidebarService.isOpen() ? 'Collapse sidebar' : 'Expand sidebar'"
            (click)="sidebarService.toggleCollapse()">
            <lucide-icon [img]="sidebarService.isOpen() ? PanelLeftClose : PanelLeft" size="14">
            </lucide-icon>
        </button>
    </div>
</aside>