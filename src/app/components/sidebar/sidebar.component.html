<!-- Two-Rail Sidebar: Icon Rail (always visible) + Content Panel (collapsible) -->
<div class="flex h-full">
    <!-- ═══════════════════════════════════════════════════════════════════════════ 
         ICON RAIL (Always Visible)
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="w-12 h-full flex flex-col border-r border-sidebar-border bg-sidebar shrink-0">
        <!-- Top Section: New Note -->
        <div class="h-10 flex items-center justify-center border-b border-sidebar-border bg-[#18181b]">
            <button
                class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-white/10 text-white transition-colors"
                title="New Note" (click)="createNote()">
                <lucide-icon [img]="Plus" size="18"></lucide-icon>
            </button>
        </div>

        <!-- Main Navigation Icons -->
        <div class="flex-1 flex flex-col items-center py-3 gap-1.5 overflow-y-auto">
            <!-- Files -->
            <button class="w-9 h-9 flex items-center justify-center rounded-lg transition-all duration-200"
                [class.bg-teal-500_20]="viewMode() === 'files'" [class.text-teal-300]="viewMode() === 'files'"
                [class.text-slate-500]="viewMode() !== 'files'" [class.hover:text-slate-300]="viewMode() !== 'files'"
                [class.hover:bg-white_5]="viewMode() !== 'files'" title="Files" (click)="setViewMode('files')">
                <lucide-icon [img]="FileText" size="18"></lucide-icon>
            </button>

            <!-- Narrative -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-lg text-purple-400 hover:text-purple-300 hover:bg-purple-500/10 transition-all duration-200"
                title="Create Narrative Vault" (click)="createNarrative()">
                <lucide-icon [img]="BookOpen" size="18"></lucide-icon>
            </button>

            <!-- Calendar -->
            <button
                class="w-9 h-9 flex items-center justify-center rounded-lg text-emerald-400 hover:text-emerald-300 hover:bg-emerald-500/10 transition-all duration-200"
                title="Fantasy Calendar" (click)="navigateToCalendar()">
                <lucide-icon [img]="Calendar" size="18"></lucide-icon>
            </button>

            <!-- Search -->
            <button class="w-9 h-9 flex items-center justify-center rounded-lg transition-all duration-200"
                [class.bg-teal-500_20]="viewMode() === 'search'" [class.text-teal-300]="viewMode() === 'search'"
                [class.text-teal-400]="viewMode() !== 'search'" [class.hover:text-teal-300]="viewMode() !== 'search'"
                [class.hover:bg-teal-500_10]="viewMode() !== 'search'" title="Semantic Search"
                (click)="setViewMode('search')">
                <lucide-icon [img]="Search" size="18"></lucide-icon>
            </button>
        </div>

        <!-- Bottom Section: Collapse Toggle -->
        <div class="h-8 flex items-center justify-center border-t border-sidebar-border">
            <button
                class="w-6 h-6 flex items-center justify-center rounded-md text-slate-500 hover:text-slate-300 hover:bg-white/5 transition-colors"
                [title]="sidebarService.isOpen() ? 'Collapse Panel' : 'Expand Panel'"
                (click)="sidebarService.toggleCollapse()">
                <lucide-icon [img]="sidebarService.isOpen() ? PanelLeftClose : PanelLeft" size="14"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════ 
         CONTENT PANEL (Collapsible)
         ═══════════════════════════════════════════════════════════════════════════ -->
    <aside
        class="h-full border-r border-sidebar-border bg-sidebar text-sidebar-foreground flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
        [class.w-60]="sidebarService.isOpen()" [class.w-0]="!sidebarService.isOpen()">

        <!-- Panel Header -->
        <div
            class="h-10 flex items-center justify-between px-3 border-b border-sidebar-border shrink-0 bg-gradient-to-r from-[#18181b] via-[#0f2a2e] to-[#134e4a] text-slate-200">
            <span class="text-sm font-semibold text-slate-200">
                {{ viewMode() === 'files' ? 'Folders' : 'Search' }}
            </span>

            <!-- Header Actions (only for files view) -->
            <div *ngIf="viewMode() === 'files'" class="flex items-center gap-0.5">
                <!-- Folder Dropdown Trigger -->
                <div class="relative">
                    <button
                        class="p-1.5 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground transition-colors"
                        title="New Folder" (click)="toggleFolderDropdown()">
                        <lucide-icon [img]="FolderPlus" size="14"></lucide-icon>
                    </button>

                    <!-- Folder Dropdown Menu -->
                    <div *ngIf="folderDropdownOpen()"
                        class="absolute top-full right-0 mt-1 z-[1000] min-w-56 bg-popover border border-border rounded-lg shadow-xl py-1 text-sm">

                        <!-- Entity Folders Header -->
                        <div class="px-3 py-1.5 text-xs font-medium text-muted-foreground uppercase tracking-wide">
                            Entity Folders
                        </div>

                        <!-- Entity Folder Options -->
                        <button *ngFor="let option of entityFolderOptions" class="folder-menu-item"
                            (click)="createEntityFolder(option)">
                            <lucide-icon [img]="option.icon" size="14" [style.color]="option.color"></lucide-icon>
                            <span class="flex-1">{{ option.label }}</span>
                            <span class="text-[10px] font-medium px-1.5 py-0.5 rounded"
                                [style.background-color]="option.color" [style.color]="'white'">
                                {{ option.entityKind }}
                            </span>
                        </button>

                        <!-- Divider -->
                        <div class="h-px bg-border my-1"></div>

                        <!-- Regular Folder -->
                        <button class="folder-menu-item" (click)="createRegularFolder()">
                            <lucide-icon [img]="Folder" size="14" class="text-muted-foreground"></lucide-icon>
                            <span class="flex-1">Regular Folder</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backdrop to close dropdown -->
        <div *ngIf="folderDropdownOpen()" class="fixed inset-0 z-40" (click)="closeFolderDropdown()">
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-hidden">
            <!-- File Tree -->
            <app-file-tree *ngIf="viewMode() === 'files'" [tree]="treeData()"></app-file-tree>

            <!-- Search Panel -->
            <app-search-panel *ngIf="viewMode() === 'search'"></app-search-panel>
        </div>

        <!-- Panel Footer -->
        <div class="h-8 flex items-center px-3 border-t border-sidebar-border shrink-0 text-xs text-muted-foreground">
            {{ treeData().length }} items
        </div>
    </aside>
</div>