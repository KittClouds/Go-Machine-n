<div class="flex h-full w-full bg-background text-foreground">
    <!-- Left Sidebar: Entity List -->
    <div class="w-[280px] min-w-[240px] border-r border-border flex flex-col bg-card/50">
        <!-- Scope Selector -->
        <!-- Scope Selector -->
        <div class="p-2 border-b border-border/50 relative z-20">
            <!-- Trigger Button -->
            <button (click)="toggleScopeMenu()"
                class="w-full flex items-center gap-2 px-3 py-2 rounded-lg bg-muted/30 hover:bg-muted/50 transition-colors text-sm group relative"
                [class.bg-muted-50]="isScopeMenuOpen()">
                <lucide-icon [img]="scopeIcon()" class="w-4 h-4 text-muted-foreground"></lucide-icon>
                <span class="text-foreground font-medium truncate flex-1 text-left">{{ scopeLabel() }}</span>
                <lucide-icon [img]="ChevronDownIcon"
                    class="w-3 h-3 text-muted-foreground transition-transform duration-200"
                    [class.rotate-180]="isScopeMenuOpen()"></lucide-icon>
            </button>

            <!-- Dropdown Menu -->
            <div *ngIf="isScopeMenuOpen()"
                class="absolute top-full left-2 right-2 mt-1 bg-popover border border-border rounded-lg shadow-lg py-1 z-30 animate-in fade-in zoom-in-95 duration-100">

                <div class="px-2 py-1.5 text-[10px] font-semibold text-muted-foreground uppercase tracking-wider">
                    Switch Scope
                </div>

                <button *ngFor="let opt of hierarchyOptions()" (click)="switchToScope(opt)"
                    class="w-full flex items-center gap-2 px-3 py-2 hover:bg-accent/50 text-left transition-colors text-sm">
                    <lucide-icon
                        [img]="opt.scope.id === 'vault:global' ? GlobeIcon : (opt.type === 'Narrative' ? BookIcon : FolderIcon)"
                        class="w-3.5 h-3.5 text-muted-foreground"></lucide-icon>
                    <span class="flex-1 truncate">{{ opt.label }}</span>
                    <span class="text-[10px] text-muted-foreground bg-muted/50 px-1.5 py-0.5 rounded">{{ opt.type
                        }}</span>
                </button>
            </div>

            <!-- Backdrop -->
            <div *ngIf="isScopeMenuOpen()" class="fixed inset-0 z-10" (click)="closeScopeMenu()"></div>
        </div>

        <!-- Header with Actions -->
        <div class="p-2 border-b border-border/50 flex items-center gap-1">
            <button
                class="flex-1 flex items-center gap-1.5 h-8 px-3 rounded-md text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-accent/50 transition-colors"
                (click)="openCreator()">
                <lucide-icon [img]="PlusIcon" class="w-3.5 h-3.5"></lucide-icon>
                Add Entity
            </button>
            <button
                class="h-8 w-8 flex items-center justify-center rounded-md text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors"
                pTooltip="Flush Registry" tooltipPosition="bottom" (click)="flushRegistry()">
                <lucide-icon [img]="Trash2Icon" class="w-3.5 h-3.5"></lucide-icon>
            </button>
        </div>

        <!-- Entity Tree -->
        <div class="flex-1 overflow-y-auto">
            <div class="p-1 space-y-0.5">
                @if (groupedEntities().length === 0) {
                <div class="text-center text-xs text-muted-foreground py-8 px-4">
                    <p>No entities registered.</p>
                    <p class="mt-1 opacity-70">Click "Add Entity" to start.</p>
                </div>
                } @else {
                @for (group of groupedEntities(); track group.kind) {
                <!-- Kind Header -->
                <button
                    class="w-full flex items-center gap-1.5 px-2 py-1.5 rounded-md hover:bg-accent/30 text-left transition-colors"
                    (click)="toggleKind(group.kind)">
                    <lucide-icon [img]="group.expanded ? ChevronDownIcon : ChevronRightIcon"
                        class="w-3 h-3 text-muted-foreground shrink-0"></lucide-icon>
                    <lucide-icon [img]="getIcon(group.kind)" class="w-3.5 h-3.5 shrink-0"
                        [style.color]="getColor(group.kind)"></lucide-icon>
                    <span class="text-[11px] font-semibold uppercase tracking-wide truncate"
                        [style.color]="getColor(group.kind)">{{ group.kind }}</span>
                    <span class="ml-auto text-[10px] text-muted-foreground bg-muted/50 px-1.5 py-0.5 rounded-full">
                        {{ group.entities.length }}
                    </span>
                </button>

                <!-- Entity Items -->
                @if (group.expanded) {
                <div class="ml-3 space-y-px">
                    @for (entity of group.entities; track entity.id) {
                    <div class="group w-full flex items-center gap-2 px-2 py-1.5 rounded-md text-left text-xs transition-colors cursor-pointer"
                        [class.bg-primary/10]="selectedEntity()?.id === entity.id"
                        [class.hover:bg-accent/30]="selectedEntity()?.id !== entity.id" (click)="selectEntity(entity)">
                        <span class="truncate flex-1 font-medium" [style.color]="getColor(entity.kind)">{{ entity.label
                            }}</span>
                        <button
                            class="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-destructive/10 transition-all"
                            (click)="deleteEntity(entity, $event)" pTooltip="Delete" tooltipPosition="left">
                            <lucide-icon [img]="Trash2Icon" class="w-3 h-3 text-destructive"></lucide-icon>
                        </button>
                    </div>
                    }
                </div>
                }
                }
                }
            </div>
        </div>

        <!-- Footer -->
        <div class="p-2 border-t border-border/50 text-center">
            <span class="text-[10px] text-muted-foreground">{{ totalEntities() }} entities</span>
        </div>
    </div>

    <!-- Right Details Panel -->
    <div class="flex-1 flex flex-col items-center justify-center p-6 bg-background relative overflow-hidden">
        <!-- Grid Background Effect -->
        <div class="absolute inset-0 z-0 opacity-[0.02]"
            style="background-image: radial-gradient(hsl(var(--foreground)) 1px, transparent 1px); background-size: 24px 24px;">
        </div>

        @if (!selectedEntity()) {
        <div class="text-center z-10">
            <div
                class="w-16 h-16 rounded-2xl bg-muted/30 flex items-center justify-center mx-auto mb-4 border border-border/50">
                <svg class="w-8 h-8 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5">
                    <circle cx="12" cy="5" r="2" />
                    <circle cx="5" cy="19" r="2" />
                    <circle cx="19" cy="19" r="2" />
                    <path d="M12 7v4M7 17l3.5-4M17 17l-3.5-4" />
                </svg>
            </div>
            <h3 class="text-base font-medium text-foreground">Select an entity from the list</h3>
            <p class="text-sm text-muted-foreground mt-1">to view and manage its connections</p>
        </div>
        } @else {
        <div class="z-10 w-full h-full overflow-y-auto">
            <app-graph-detail [entity]="selectedEntity()!"></app-graph-detail>
        </div>
        }
    </div>
</div>

<!-- Entity Creator Dialog -->
<app-entity-creator-dialog [(visible)]="isCreatorOpen" [editEntity]="editingEntity()"
    (save)="onSaveEntity($event)"></app-entity-creator-dialog>